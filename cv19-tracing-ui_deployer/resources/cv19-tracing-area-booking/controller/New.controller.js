sap.ui.define(["cv19/tracing/area/booking/cv19-tracing-area-booking/controller/BaseController","sap/ui/unified/CalendarLegendItem","sap/ui/unified/DateTypeRange","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,a,r,n){"use strict";return e.extend("cv19.tracing.area.booking.cv19-tracing-area-booking.controller.New",{__targetName:"New",_bDateIsSelectable:false,_bFirstTime:true,onRouteMatched:function(e){this.__setLayout("TwoColumnsBeginExpanded");this.__eraseNewBookingObject();var t=new Date;t.setDate(1);t.setHours(0,0,0);this.__setCalendarDateIntervalInModel(t);this._bFirstTime=true},onBeforeRendering:function(){this.__fetchAreas()},onNavBack:function(){this.getRouter().navTo("Main",{},false)},onSelectAreaSelectionChange:function(e){var t=e.getParameter("selectedItem"),a=t.getBindingContext().getObject();this.__getAreaCapacityDetails(a);if(this._bFirstTime){setTimeout(function(){this.byId("datePickerCalendar").destroySelectedDates();this._bFirstTime=false}.bind(this),100)}},onCalendarStartDateChange:function(e){var t=e.getSource().getStartDate();this.__setCalendarDateIntervalInModel(t)},onDatePickerCalendarSelect:function(e){var t=e.getSource(),a=this.getView().byId("selectArea").getSelectedItem().getText(),n=t.getSelectedDates()[0].getStartDate(),o=t.getSpecialDates();this._bDateIsSelectable=this.__checkIfSelectedDateIsOk(n,o);if(!this._bDateIsSelectable){r.error(this.getTranslation("noCapacityAvailableForSelectedDate",[a,n.toDateString()]));return}var i=this.getComponentModel(),s=i.getProperty("/newBooking"),l=new Date(n.setHours(0,0,0)),c=new Date(n.setHours(23,59,59));s.DateStart=l;s.DateEnd=c;i.refresh()},onSaveButtonPress:function(e){var t=this.getComponentModel(),a=this.getComponentModel("odata"),o=t.getProperty("/user"),i=t.getProperty("/newBooking"),s=this.__checkIfAllFieldsAreOk(i);if(!s){r.error(this.getTranslation("someMandatoryFieldsAreMissing"));return}this.__setBookingDateInterval(i);var l=t.getProperty("/areas"),c=_.find(l,function(e){return e.DeviceID==i.AreaID}),d={ID:(new Date).getTime(),Subject:this.getTranslation("userInArea",[o.name.familyName,o.name.givenName]),DateStart:this.__getDateFromUTC(i.DateStart),DateEnd:this.__getDateFromUTC(i.DateEnd),PartecipantsNumber:1,Notes:i.Notes,RoomID:i.AreaID,EmployeeID:o.id,ApprovalStatus:0};this.__oArea=c;this.setAppBusy(true);a.create("/ReservationSet",d,{success:async function(){try{d.RoomName=this.__oArea.Description;await this.__createWFTask(d,o)}catch(e){this.__handleCommunicationErrorMessageDisplay("errorCreatingWFForYourRequest",e)}this.setAppBusy(false);n.show(this.getTranslation("newBookingSavedSuccessfully"));this.onNavBack();await this.__getMyBookings()}.bind(this),error:function(e){this.__handleCommunicationErrorMessageDisplay("newBookingNotSavedSuccessfully",e);this.setAppBusy(false)}.bind(this)})},__eraseNewBookingObject:function(){var e=this.getComponentModel();e.setProperty("/newBooking",{AreaID:null,DateStart:null,DateEnd:null,Notes:"",timeframe:"wholeDay"})},__getAreaCapacityDetails:async function(e){var t=this.getComponentModel("odata"),a=this.getComponentModel(),r=a.getProperty("/calendarStartDate"),n=a.getProperty("/calendarEndDate"),o=t.createKey("/OccupationByDateParameters",{StartDate:r,EndDate:n,AreaId:e.DeviceID});this.setAppBusy(true);try{var i=await this.__fetchDataFromBackEnd({path:o+"/Results"}),s=i.results;this.__updateCalendar(e,s)}catch(e){this.__handleCommunicationErrorMessageDisplay("errorFetchingCalendarDatesCapacity",e)}},__updateCalendar:function(e,r){var n=this.getView().byId("datePickerCalendar"),o=this.getView().byId("datePickerCalendarLegend");n.destroySpecialDates();o.destroyItems();for(var i in r){var s=r[i],l=this.__getCalendarTypeDetails(s.capacity,e.Capacity);if(l){n.addSpecialDate(new a({startDate:s.startDate,color:l.color,tooltip:l.tooltip}))}}o.addItem(new t({text:this.getTranslation("calendarWarningTooltip"),color:"#e9730c"}));o.addItem(new t({text:this.getTranslation("calendarErrorTooltip"),color:"#bb0000"}));this.setAppBusy(false)},__getCalendarTypeDetails:function(e,t){var a=e/t*100;if(a<85){return null}if(a>=85&&a<100){return{color:"#e9730c",tooltip:this.getTranslation("calendarWarningTooltip")}}return{color:"#bb0000",tooltip:this.getTranslation("calendarErrorTooltip")}},__setCalendarDateIntervalInModel:function(e){var t=this.__getLastDayOfMonth(e),a=this.getComponentModel();a.setProperty("/calendarStartDate",this.__addDaysToDate(e,-1));a.setProperty("/calendarEndDate",this.__addDaysToDate(t,1))},__checkIfSelectedDateIsOk:function(e,t){var a=e.getDate(),r=e.getMonth();for(var n in t){var o=t[n].getStartDate(),i=t[n].getColor()==="#bb0000",s=o.getDate(),l=o.getMonth();if(i){if(s===a&&l===r){return false}}}return true},__checkIfAllFieldsAreOk:function(e){return!!e.AreaID&&!!e.DateStart&&!!e.DateEnd&&!!this._bDateIsSelectable},__setBookingDateInterval:function(e){var t=e.DateStart,a=e.DateEnd,r=e.timeframe;switch(r){case"wholeday":t.setHours(0,0,0);a.setHours(23,59,59);break;case"morning":t.setHours(0,0,0);a.setHours(12,0,0);break;case"afternoon":t.setHours(12,0,1);a.setHours(23,59,59);break}e.DateStart=t;e.DateEnd=a},__createWFTask:function(e,t){return new Promise(function(a,n){var o=this.getComponentModel(),i=o.getProperty("/wfInitData");i.context.u={aM:t.approver||"john.doe@sap.demo",e:t.emails[0].value||"mary.pierce@sap.demo",n:[t.name.givenName,t.name.familyName].join(" ")};i.context.r={i:e.ID,s:e.Subject,sd:this.__formatDateString(e.DateStart),ed:this.__formatDateString(e.DateEnd),p:""+e.PartecipantsNumber,n:e.Notes||"",rN:e.RoomName};i.context.originalTask=e;var s=this.__getLocationUrl();i.context.appRouterUrl=s;$.ajax({url:"/bpmworkflowruntime/v1/xsrf-token",method:"GET",headers:{"X-CSRF-Token":"Fetch"},success:function(e,t,o){var s=o.getResponseHeader("X-CSRF-Token");if(s===null)return;$.ajax({url:"/bpmworkflowruntime/v1/workflow-instances",type:"POST",data:JSON.stringify(i),headers:{"X-CSRF-Token":s,"Content-Type":"application/json"},async:false,success:function(){r.information(this.getTranslation("approvalRequestHasBeenSent"));a(true)}.bind(this),error:function(e){n(e)}.bind(this)})}.bind(this)})}.bind(this))}})});