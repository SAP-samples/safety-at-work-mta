sap.ui.define(["jquery.sap.global","sap/m/MessageBox","sap/m/MessageToast","sap/ui/core/mvc/Controller","sap/ui/core/routing/History","cv19/tracing/area/booking/cv19-tracing-area-booking/util/formatter","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,n,r,o,a,s,i,u,c){"use strict";return r.extend("cv19.tracing.area.booking.cv19-tracing-area-booking.controller.BaseController",{__targetName:null,__MESSAGE_BOX_CHANNEL:"message_box",__MESSAGE_BOX_EVENT:"fired",__TOAST_ERROR:"error",__TOAST_INFO:"info",__TOAST_WARNING:"warning",__TOAST_SUCCESS:"success",_tableColumnsSettingsDialog:null,formatter:a,logger:null,onInit:function(){if(this.__targetName!==undefined&&this.__targetName!==null){var e=typeof this.__targetName==="string"?[this.__targetName]:this.__targetName;for(var t=0;t<e.length;t++){var n=this.getRouter().getRoute(e[t]);if(n){n.attachPatternMatched(this._onRouteMatched,this)}}}this.logger=this.getOwnerComponent().logger;this._onInit.apply(this)},_onInit:function(){},onAfterRendering:async function(){try{var e=this.getComponentModel(),t=await this._getUserInfos();e.setProperty("/user",t);this.__getMyBookings()}catch(e){console.error(e)}},setAppBusy:function(e){this.getComponentModel().setProperty("/busy",e)},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onNavBack:function(){this.getRouter().navTo("Main",{},false)},navTo:function(e,t,n){this.getRouter().navTo(e,t,n)},_onRouteMatched:function(e){var t=e.getParameters().arguments;var n=[e,e.getParameters().name];for(var r in t){if(t.hasOwnProperty(r)){var o=t[r];n.push(o)}}this.__getMyBookings();this.onRouteMatched.apply(this,n)},onRouteMatched:function(e,t){},getComponentModel:function(e){var t=this.getOwnerComponent();var n=e==null||e===undefined?t.getModel():t.getModel(e);return n},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},getTranslation:function(e,t){if(t===undefined||t===null){return this.getResourceBundle().getText(e)}else{return this.getResourceBundle().getText(e,t)}},getFragmentControlById:function(e,t){var n=c.createId(e,t);return sap.ui.getCore().byId(n)},sendEvent:function(e,t,n){sap.ui.getCore().getEventBus().publish(e,t,n)},subscribe:function(e,t,n,r){sap.ui.getCore().getEventBus().subscribe(e,t,n,r)},unSubscribe:function(e,t,n,r){sap.ui.getCore().getEventBus().unsubscribe(e,t,n,r)},_getUserInfos:function(){return new Promise(function(e,t){$.ajax({url:"/js_api/userInfo",method:"GET",dataType:"json",context:this,success:function(t){e(t)},error:function(e,n,r){var o="Error retrieving user info\nError"+e.status+" - "+e.responseText;t(o)}})})},_generateUuidv4:function(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},_setSelectedPage:function(e){var t=this.getComponentModel("local");t.setProperty("/selectedPage",e)},_getSelectedView:function(){return this.getOwnerComponent().__selectedView},_setSelectedView:function(e){this.getOwnerComponent().__selectedView=e},__getUTCDate(e){return new Date(e.getTime()+e.getTimezoneOffset()*6e4)},__getDateFromUTC(e){return new Date(e.getTime()-e.getTimezoneOffset()*6e4)},__addDaysToDate:function(e,t){return new Date(e.getTime()+t*24*3600*1e3)},__handleCommunicationErrorMessageDisplay:function(e,n){var r="";try{r=JSON.parse(n.responseText).error.message.value}catch(e){r=n.message}t.error(this.getTranslation(e,[r]))},__setLayout:function(e){this.getComponentModel().setProperty("/layout",e)},__getMyBookings:async function(){var e=this.__getUTCDate(new Date),t=[],n=this.getComponentModel(),r=n.getProperty("/user");e.setHours(0,0,0);t.push(new i({path:"Type",operator:u.EQ,value1:"AREA"}));t.push(new i({path:"DateStart",operator:u.GE,value1:e}));t.push(new i({path:"EmployeeID",operator:u.EQ,value1:r.id}));t=new i(t,true);try{this.setAppBusy(true);var o=await this.__fetchDataFromBackEnd({path:"/RoomReservationSet",filters:t,sorters:new s("DateStart",false)});n.setProperty("/myBookings",o.results);this.setAppBusy(false)}catch(e){this.__handleCommunicationErrorMessageDisplay("errorFetchingMyBookings",e)}},__fetchDataFromBackEnd:function(e){return new Promise(function(t,n){var r=e.filters||null,o=e.sorters||null,a=this.getComponentModel("odata");a.read(e.path,{filters:r?[r]:null,sorters:o?[o]:null,urlParameters:e.urlParameters,success:function(n){console.log(e.path+" -- data received",n);t(n)}.bind(this),error:function(e){n(e)}})}.bind(this))},__fetchAreas:async function(){var e=this.getComponentModel(),t=this.getComponentModel("odata");this.setAppBusy(true);var n=await this.__fetchDataFromBackEnd({path:"/DeviceSet",filters:[new i("Type",u.EQ,"AREA")],urlParameters:{$select:"DeviceID,Type,Description,Capacity"}}),e=this.getComponentModel();e.setProperty("/areas",n.results);this.setAppBusy(false)},__getLastDayOfMonth:function(e){var t=new Date(e.getFullYear(),e.getMonth()+1,0);t.setHours(23,59,59);return t},__formatDateString:function(e){var t=sap.ui.core.format.DateFormat.getInstance({format:"yMMMd"});return t.format(e)},__formatDateTimeString:function(e){var t=ssap.ui.core.format.DateFormat.getDateTimeInstance({format:"yMMMdHHmm"});return t.format(e)},__getLocationUrl:function(){return window.location.protocol+"//"+window.location.host}})});