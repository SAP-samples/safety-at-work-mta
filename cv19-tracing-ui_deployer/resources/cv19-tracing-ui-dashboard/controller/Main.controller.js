sap.ui.define(["covid19/ui/dashboard/cv19-tracing-ui-dashboard/controller/BaseController","sap/ui/model/Filter","sap/ui/model/Sorter","covid19/ui/dashboard/cv19-tracing-ui-dashboard/util/chartsData"],function(e,t,a,i){"use strict";return e.extend("covid19.ui.dashboard.cv19-tracing-ui-dashboard.controller.Main",{__targetName:"Main",__savedFilters:[],__statusFilters:[],__initDateRange:{dStart:new Date("2020-01-01"),dEnd:new Date},__selectedDateRange:{dStart:null,dEnd:null},onRouteMatched:function(){this.initHeatmapChart()},onAfterRendering:function(){var e=this.getView().createId("F00_DynamicPageHeaderFilterBar"),t=this.getFragmentControlById(e,"tagsMultiComboBoxFilter");t.setFilterFunction(function(e,t){var a=t.getText().toLowerCase(),i=e.toLowerCase();return a.indexOf(i)>-1})},onFilterBarSearch:function(e){var t=this._getRealTimeTable(),a=this._getHistoricHeatmapChart();this.__savedFilters=this._getAllFilters(e);this._applyFiltersToRealTimeTable(t,true);this._applyFiltersToHeatMapChart(a,true)},onTableColumnHeaderButtonPress:function(e){var t=e.getSource(),i=t.data("sorterProperty"),r=!(t.data("descending")==="true"),s=this._getRealTimeTable();this.__setAllColumnButtonsTransparent(s);s.getBinding("items").sort(new a(i,r));t.getCustomData()[1].setValue(""+r);t.setIcon(r?"sap-icon://sort-descending":"sap-icon://sort-ascending");t.setType("Emphasized")},onRealTimeTableDeviceStatusesMCBChange:function(e){var a=e.getSource(),i=a.getSelectedItems(),r=this._getRealTimeTable(),s=[];for(var n in i){var l=i[n].getKey(),o=null;switch(l){case"ok":s.push(new t("MeasuredPercentage","LE",100));break;case"warning":var d=[];d.push(new t("MeasuredPercentage","GT",100));d.push(new t("MeasuredPercentage","LE",125));s.push(new t(d,true));break;case"error":s.push(new t("MeasuredPercentage","GT",125));break}}this.__statusFilters=s.length>0?new t(s,false):[];this._applyFiltersToRealTimeTable(r)},initHeatmapChart:function(){var e=this.getView().createId("F02_HistoryDataHeatmapTab"),t=this.getFragmentControlById(e,"heatmapChart");t.setVizProperties(i.vizProperties);var r=this.getFragmentControlById(e,"heatmapPopOver");r.connect(t.getVizUid());t.getDataset().bindData({model:"odata",path:"/HistoryDevicesStatusParameters(StartDate='"+this.__initDateRange.dStart.toISOString()+"',%20EndDate='"+this.__initDateRange.dEnd.toISOString()+"')/Results",sorter:new a("TimeFrame",false)})},__setAllColumnButtonsTransparent:function(e){var t=e.getColumns();for(var a in t){var i=t[a],r=i.getHeader();if(r.getMetadata().getElementName()!=="sap.m.Text"){r.setType("Transparent");r.setIcon("sap-icon://sorting-ranking")}}},_getRealTimeTable:function(){var e=this.getView().createId("F01_RealTimeDevicesSituationTab"),t=this.getFragmentControlById(e,"realTimeDeviceMonitorTable");return t},_getHistoricHeatmapChart:function(){var e=this.getView().createId("F02_HistoryDataHeatmapTab"),t=this.getFragmentControlById(e,"heatmapChart");return t},_getAllFilters:function(e){var a=e.getSource(),i=a.getFilterGroupItems(),r=i[0].getControl(),s=i[1].getControl(),n=i[2].getControl(),l=[];var o=r.getValue();if(o){l.push(new t({path:"Description",opeartor:"Contains",value1:o,caseInsensitive:true}))}var d=n.getDateValue(),g=n.getSecondDateValue();if(d&&g){this.__selectedDateRange.dStart=d!==null?d:this.__initDateRange.dStart;this.__selectedDateRange.dEnd=g!==null?g:new Date}var u=s.getSelectedItems(),h=this.__getFiltersFromItemsCollection(u,"TagsString");if(h){l.push(h)}if(l.length>0){l=new t(l,true);return l}else{return[]}},__getFiltersFromItemsCollection:function(e,a){var i=[];for(var r in e){i.push(new t(a,"Contains",e[r].getKey()))}return i.length>0?new t(i,false):null},_applyFiltersToRealTimeTable:function(e,a){var i=[];if(this.__savedFilters.hasOwnProperty("aFilters")&&this.__savedFilters.aFilters.length>0){i.push(this.__savedFilters)}if(this.__statusFilters.hasOwnProperty("aFilters")&&this.__statusFilters.aFilters.length>0){i.push(this.__statusFilters)}if(i.length>0){e.getBinding("items").filter(new t(i,true))}else{e.getBinding("items").filter([])}if(a){e.getBinding("items").resume()}},_applyFiltersToHeatMapChart:function(e){var t=[];if(this.__savedFilters.hasOwnProperty("aFilters")&&this.__savedFilters.aFilters.length>0){t.push(this.__savedFilters)}if(this.__statusFilters.hasOwnProperty("aFilters")&&this.__statusFilters.aFilters.length>0){t.push(this.__statusFilters)}if(t.length>0||(this.__selectedDateRange.dStart!=null||this.__selectedDateRange.dEnd!=null)){var i=this.__selectedDateRange.dStart!=null?this.__selectedDateRange.dStart.toISOString():this.__initDateRange.dStart.toISOString();var r=this.__selectedDateRange.dEnd!=null?this.__selectedDateRange.dEnd.toISOString():this.__initDateRange.dEnd.toISOString();e.getDataset().bindData({model:"odata",path:"/HistoryDevicesStatusParameters(StartDate='"+i+"', EndDate='"+r+"')/Results",sorter:new a("TimeFrame",false),filters:t})}}})});